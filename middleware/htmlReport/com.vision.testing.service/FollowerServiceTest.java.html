<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FollowerServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in middleware Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.vision.testing.service</a> &gt; <span class="el_source">FollowerServiceTest.java</span></div><h1>FollowerServiceTest.java</h1><pre class="source lang-java linenums">package com.vision.testing.service;

import com.vision.middleware.domain.ApplicationUser;
import com.vision.middleware.domain.Role;
import com.vision.middleware.domain.relations.UserFollows;
import com.vision.middleware.repo.UserFollowsRepository;
import com.vision.middleware.service.FollowerService;
import com.vision.middleware.service.UserService;
import com.vision.middleware.utils.JwtUtil;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.*;

import static org.assertj.core.api.AssertionsForInterfaceTypes.assertThat;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
<span class="fc" id="L23">public class FollowerServiceTest {</span>

    @InjectMocks
    private FollowerService followerService;

    @Mock
    private UserFollowsRepository followsRepository;

    @Mock
    private UserService userService;

    private ApplicationUser user1;
    private ApplicationUser user2;
    private ApplicationUser user3;

    @BeforeEach
    void setUp() {
<span class="fc" id="L40">        Role userRole = new Role();</span>
<span class="fc" id="L41">        userRole.setAuthority(&quot;USER&quot;);</span>

        // Create user with userId 1
<span class="fc" id="L44">        user1 = ApplicationUser.builder()</span>
<span class="fc" id="L45">                .id(1L)</span>
<span class="fc" id="L46">                .username(&quot;user1&quot;)</span>
<span class="fc" id="L47">                .fullName(&quot;a&quot;)</span>
<span class="fc" id="L48">                .password(&quot;encodedPassword1&quot;)</span>
<span class="fc" id="L49">                .authorities(new HashSet&lt;&gt;(Set.of(userRole)))</span>
<span class="fc" id="L50">                .email(&quot;user1@example.com&quot;)</span>
<span class="fc" id="L51">                .phoneNumber(&quot;1234567890&quot;)</span>
<span class="fc" id="L52">                .address(&quot;123 Test St&quot;)</span>
<span class="fc" id="L53">                .city(&quot;Test City&quot;)</span>
<span class="fc" id="L54">                .state(&quot;Test State&quot;)</span>
<span class="fc" id="L55">                .zipCode(&quot;12345&quot;)</span>
<span class="fc" id="L56">                .country(&quot;Test Country&quot;)</span>
<span class="fc" id="L57">                .followerCount(0)</span>
<span class="fc" id="L58">                .build();</span>

        // Create user with userId 2
<span class="fc" id="L61">        user2 = ApplicationUser.builder()</span>
<span class="fc" id="L62">                .id(2L)</span>
<span class="fc" id="L63">                .username(&quot;user2&quot;)</span>
<span class="fc" id="L64">                .fullName(&quot;a&quot;)</span>
<span class="fc" id="L65">                .password(&quot;encodedPassword2&quot;)</span>
<span class="fc" id="L66">                .authorities(new HashSet&lt;&gt;(Set.of(userRole)))</span>
<span class="fc" id="L67">                .email(&quot;user2@example.com&quot;)</span>
<span class="fc" id="L68">                .phoneNumber(&quot;1234567890&quot;)</span>
<span class="fc" id="L69">                .address(&quot;123 Test St&quot;)</span>
<span class="fc" id="L70">                .city(&quot;Test City&quot;)</span>
<span class="fc" id="L71">                .state(&quot;Test State&quot;)</span>
<span class="fc" id="L72">                .zipCode(&quot;12345&quot;)</span>
<span class="fc" id="L73">                .country(&quot;Test Country&quot;)</span>
<span class="fc" id="L74">                .followerCount(0)</span>
<span class="fc" id="L75">                .build();</span>

        // Create user with userId 3
<span class="fc" id="L78">        user3 = ApplicationUser.builder()</span>
<span class="fc" id="L79">                .id(3L)</span>
<span class="fc" id="L80">                .username(&quot;user3&quot;)</span>
<span class="fc" id="L81">                .fullName(&quot;a&quot;)</span>
<span class="fc" id="L82">                .password(&quot;encodedPassword3&quot;)</span>
<span class="fc" id="L83">                .authorities(new HashSet&lt;&gt;(Set.of(userRole)))</span>
<span class="fc" id="L84">                .email(&quot;user3@example.com&quot;)</span>
<span class="fc" id="L85">                .phoneNumber(&quot;1234567890&quot;)</span>
<span class="fc" id="L86">                .address(&quot;123 Test St&quot;)</span>
<span class="fc" id="L87">                .city(&quot;Test City&quot;)</span>
<span class="fc" id="L88">                .state(&quot;Test State&quot;)</span>
<span class="fc" id="L89">                .zipCode(&quot;12345&quot;)</span>
<span class="fc" id="L90">                .country(&quot;Test Country&quot;)</span>
<span class="fc" id="L91">                .followerCount(0)</span>
<span class="fc" id="L92">                .build();</span>
<span class="fc" id="L93">    }</span>

    @Test
    void testUser1FollowsUser2() {
<span class="fc" id="L97">        when(userService.loadUserById(1L)).thenReturn(user1);</span>
<span class="fc" id="L98">        when(userService.loadUserById(2L)).thenReturn(user2);</span>
        // user 1 does not follow user 2 to begin with.
<span class="fc" id="L100">        when(followsRepository.findByFollowerAndFollowee(user1, user2)).thenReturn(Optional.empty());</span>

<span class="fc" id="L102">        followerService.followUser(1L, 2L);</span>

        // relation should be saved
<span class="fc" id="L105">        verify(followsRepository, times(1)).save(any(UserFollows.class));</span>
<span class="fc" id="L106">    }</span>

    @Test
    void testUser1FollowsUser2ButAlreadyFollowsThem() {
<span class="fc" id="L110">        when(userService.loadUserById(1L)).thenReturn(user1);</span>
<span class="fc" id="L111">        when(userService.loadUserById(2L)).thenReturn(user2);</span>
        // relation exists:
<span class="fc" id="L113">        when(followsRepository.findByFollowerAndFollowee(user1, user2))</span>
<span class="fc" id="L114">                .thenReturn(Optional.of(new UserFollows()));</span>

<span class="fc" id="L116">        followerService.followUser(1L, 2L);</span>

        // relation exists already, so followsRepository's save() method
        // should not ever be run.
<span class="fc" id="L120">        verify(followsRepository, never()).save(any(UserFollows.class));</span>
<span class="fc" id="L121">    }</span>

    @Test
    void testUser1FollowsUser2And3() {
<span class="fc" id="L125">        when(userService.loadUserById(1L)).thenReturn(user1);</span>
<span class="fc" id="L126">        when(userService.loadUserById(2L)).thenReturn(user2);</span>
<span class="fc" id="L127">        when(userService.loadUserById(3L)).thenReturn(user3);</span>

        // relation dne
<span class="fc" id="L130">        when(followsRepository.findByFollowerAndFollowee(user1, user2))</span>
<span class="fc" id="L131">                .thenReturn(Optional.empty());</span>
<span class="fc" id="L132">        when(followsRepository.findByFollowerAndFollowee(user1, user3))</span>
<span class="fc" id="L133">                .thenReturn(Optional.empty());</span>

<span class="fc" id="L135">        followerService.followUser(1L, 2L);</span>
<span class="fc" id="L136">        followerService.followUser(1L, 3L);</span>

<span class="fc" id="L138">        verify(followsRepository, times(2)).save(any(UserFollows.class));</span>
<span class="fc" id="L139">    }</span>

    @Test
    void testUser1UnfollowsUser2() {
<span class="fc" id="L143">        when(userService.loadUserById(1L)).thenReturn(user1);</span>
<span class="fc" id="L144">        when(userService.loadUserById(2L)).thenReturn(user2);</span>

<span class="fc" id="L146">        followerService.unfollowUser(1L, 2L);</span>

<span class="fc" id="L148">        verify(followsRepository, times(1)).deleteByFollowerAndFollowee(user1, user2);</span>
<span class="fc" id="L149">    }</span>

    @Test
    void testGetByFollowing() {
<span class="fc" id="L153">        when(userService.loadUserById(1L)).thenReturn(user1);</span>
<span class="fc" id="L154">        when(followsRepository.findByFollower(user1)).thenReturn(Collections.singletonList(new UserFollows()));</span>

<span class="fc" id="L156">        List&lt;UserFollows&gt; result = followerService.getByFollowingUser(1L);</span>

<span class="fc" id="L158">        assertThat(result).isNotEmpty();</span>
<span class="fc" id="L159">        verify(followsRepository, times(1)).findByFollower(user1);</span>
<span class="fc" id="L160">    }</span>

    @Test
    void testGetByFollowee() {
<span class="fc" id="L164">        when(userService.loadUserById(1L)).thenReturn(user1);</span>
<span class="fc" id="L165">        when(followsRepository.findByFollowee(user1)).thenReturn(Collections.singletonList(new UserFollows()));</span>

<span class="fc" id="L167">        List&lt;UserFollows&gt; result = followerService.getByFolloweeUser(1L);</span>

<span class="fc" id="L169">        verify(followsRepository, times(1)).findByFollowee(user1);</span>
<span class="fc" id="L170">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>