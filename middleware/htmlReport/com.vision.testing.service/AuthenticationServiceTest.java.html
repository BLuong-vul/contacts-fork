<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthenticationServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in middleware Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.vision.testing.service</a> &gt; <span class="el_source">AuthenticationServiceTest.java</span></div><h1>AuthenticationServiceTest.java</h1><pre class="source lang-java linenums">package com.vision.testing.service;

import com.vision.middleware.domain.ApplicationUser;
import com.vision.middleware.domain.Role;
import com.vision.middleware.dto.LoginResponseDTO;
import com.vision.middleware.dto.RegistrationDTO;
import com.vision.middleware.repo.RoleRepository;
import com.vision.middleware.repo.UserRepository;
import com.vision.middleware.service.AuthenticationService;
import com.vision.middleware.service.TokenService;
import org.hibernate.exception.ConstraintViolationException;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.BadCredentialsException;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.security.crypto.password.PasswordEncoder;

import java.util.HashSet;
import java.util.Optional;
import java.util.Set;

import static org.assertj.core.api.AssertionsForClassTypes.assertThat;
import static org.assertj.core.api.AssertionsForClassTypes.assertThatThrownBy;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
<span class="fc" id="L37">public class AuthenticationServiceTest {</span>

    @InjectMocks
    private AuthenticationService authenticationService;

    @Mock
    private UserRepository userRepository;

    @Mock
    private RoleRepository roleRepository;

    @Mock
    private PasswordEncoder passwordEncoder;

    @Mock
    private AuthenticationManager authenticationManager;

    @Mock
    private TokenService tokenService;

    private RegistrationDTO registrationDTO;
    private Role userRole;

    @BeforeEach
    public void setUp() {
<span class="fc" id="L62">        registrationDTO = RegistrationDTO.builder()</span>
<span class="fc" id="L63">                .username(&quot;testUser&quot;)</span>
<span class="fc" id="L64">                .password(&quot;testPassword&quot;)</span>
<span class="fc" id="L65">                .fullName(&quot;a&quot;)</span>
<span class="fc" id="L66">                .email(&quot;test@example.com&quot;)</span>
<span class="fc" id="L67">                .phoneNumber(&quot;1234567890&quot;)</span>
<span class="fc" id="L68">                .address(&quot;123 Test St&quot;)</span>
<span class="fc" id="L69">                .city(&quot;Test City&quot;)</span>
<span class="fc" id="L70">                .state(&quot;Test State&quot;)</span>
<span class="fc" id="L71">                .zipCode(&quot;12345&quot;)</span>
<span class="fc" id="L72">                .country(&quot;Test Country&quot;)</span>
<span class="fc" id="L73">                .build();</span>

<span class="fc" id="L75">        userRole = new Role();</span>
<span class="fc" id="L76">        userRole.setAuthority(&quot;USER&quot;);</span>
<span class="fc" id="L77">    }</span>

    @Test
    public void testRegisterUserSuccess() throws ConstraintViolationException {
<span class="fc" id="L81">        ApplicationUser savedUser = ApplicationUser.builder()</span>
<span class="fc" id="L82">                .id(1L)</span>
<span class="fc" id="L83">                .username(&quot;testUser&quot;)</span>
<span class="fc" id="L84">                .password(&quot;encodedPassword&quot;)</span>
<span class="fc" id="L85">                .fullName(&quot;a&quot;)</span>
<span class="fc" id="L86">                .authorities(new HashSet&lt;&gt;(Set.of(userRole)))</span>
<span class="fc" id="L87">                .email(&quot;test@example.com&quot;)</span>
<span class="fc" id="L88">                .phoneNumber(&quot;1234567890&quot;)</span>
<span class="fc" id="L89">                .address(&quot;123 Test St&quot;)</span>
<span class="fc" id="L90">                .city(&quot;Test City&quot;)</span>
<span class="fc" id="L91">                .state(&quot;Test State&quot;)</span>
<span class="fc" id="L92">                .zipCode(&quot;12345&quot;)</span>
<span class="fc" id="L93">                .country(&quot;Test Country&quot;)</span>
<span class="fc" id="L94">                .followerCount(0)</span>
<span class="fc" id="L95">                .build();</span>

<span class="fc" id="L97">        when(roleRepository.findByAuthority(&quot;USER&quot;)).thenReturn(Optional.of(userRole));</span>
<span class="fc" id="L98">        when(passwordEncoder.encode(any(String.class))).thenReturn(&quot;encodedPassword&quot;);</span>
<span class="fc" id="L99">        when(userRepository.save(any(ApplicationUser.class))).thenReturn(savedUser);</span>

<span class="fc" id="L101">        ApplicationUser registeredUser = authenticationService.registerUser(registrationDTO);</span>

<span class="fc" id="L103">        assertThat(registeredUser).isNotNull();</span>
<span class="fc" id="L104">        assertThat(registeredUser.getUsername()).isEqualTo(&quot;testUser&quot;);</span>
<span class="fc" id="L105">        assertThat(registeredUser.getPassword()).isEqualTo(&quot;encodedPassword&quot;);</span>
<span class="fc" id="L106">        assertThat(registeredUser.getAuthorities().size()).isEqualTo(1);</span>
<span class="fc" id="L107">        assertTrue(registeredUser.getAuthorities().contains(userRole));</span>
<span class="fc" id="L108">    }</span>

    @Test
    public void testRegisterUserRoleNotFound() {
<span class="fc" id="L112">        when(roleRepository.findByAuthority(&quot;USER&quot;)).thenReturn(Optional.empty());</span>

<span class="pc" id="L114">        assertThatThrownBy(() -&gt; authenticationService.registerUser(registrationDTO))</span>
<span class="fc" id="L115">                .isInstanceOf(RuntimeException.class);</span>
<span class="fc" id="L116">    }</span>

    @Test
    public void testLoginUserSuccess() throws AuthenticationException {
<span class="fc" id="L120">        String username = &quot;testUser&quot;;</span>
<span class="fc" id="L121">        String password = &quot;testPassword&quot;;</span>

<span class="fc" id="L123">        ApplicationUser user = ApplicationUser.builder()</span>
<span class="fc" id="L124">                .id(1L)</span>
<span class="fc" id="L125">                .username(username)</span>
<span class="fc" id="L126">                .password(&quot;encodedPassword&quot;)</span>
<span class="fc" id="L127">                .fullName(&quot;a&quot;)</span>
<span class="fc" id="L128">                .email(&quot;test@example.com&quot;)</span>
<span class="fc" id="L129">                .phoneNumber(&quot;1234567890&quot;)</span>
<span class="fc" id="L130">                .address(&quot;123 Test St&quot;)</span>
<span class="fc" id="L131">                .city(&quot;Test City&quot;)</span>
<span class="fc" id="L132">                .state(&quot;Test State&quot;)</span>
<span class="fc" id="L133">                .zipCode(&quot;12345&quot;)</span>
<span class="fc" id="L134">                .country(&quot;Test Country&quot;)</span>
<span class="fc" id="L135">                .followerCount(0)</span>
<span class="fc" id="L136">                .authorities(new HashSet&lt;&gt;(Set.of(userRole)))</span>
<span class="fc" id="L137">                .build();</span>

<span class="fc" id="L139">        when(userRepository.findByUsername(username)).thenReturn(Optional.of(user));</span>
<span class="fc" id="L140">        when(authenticationManager.authenticate(any(UsernamePasswordAuthenticationToken.class))).thenReturn(mock(Authentication.class));</span>
<span class="fc" id="L141">        when(tokenService.generateJwt(any(Authentication.class), eq(1L))).thenReturn(&quot;testToken&quot;);</span>

<span class="fc" id="L143">        LoginResponseDTO loginResponseDTO = authenticationService.loginUser(username, password);</span>

<span class="fc" id="L145">        assertThat(loginResponseDTO).isNotNull();</span>
<span class="fc" id="L146">        assertThat(loginResponseDTO.getUsername()).isEqualTo(username);</span>
<span class="fc" id="L147">        assertThat(loginResponseDTO.getUserId()).isEqualTo(1L);</span>
<span class="fc" id="L148">        assertThat(loginResponseDTO.getRoles().size()).isEqualTo(1);</span>
<span class="fc" id="L149">        assertTrue(loginResponseDTO.getRoles().contains(userRole));</span>
<span class="fc" id="L150">        assertThat(loginResponseDTO.getJwt()).isEqualTo(&quot;testToken&quot;);</span>
<span class="fc" id="L151">    }</span>

    @Test
    public void testLoginUserNotFound() {
<span class="fc" id="L155">        String username = &quot;testUser&quot;;</span>
<span class="fc" id="L156">        String password = &quot;testPassword&quot;;</span>

<span class="fc" id="L158">        when(userRepository.findByUsername(username)).thenReturn(Optional.empty());</span>

<span class="pc" id="L160">        assertThatThrownBy(() -&gt; authenticationService.loginUser(username, password))</span>
<span class="fc" id="L161">                .isInstanceOf(UsernameNotFoundException.class);</span>
<span class="fc" id="L162">    }</span>

    @Test
    public void testLoginUserBadCredentials() {
<span class="fc" id="L166">        String username = &quot;testUser&quot;;</span>
<span class="fc" id="L167">        String password = &quot;wrongPassword&quot;;</span>

<span class="fc" id="L169">        when(authenticationManager.authenticate(any(UsernamePasswordAuthenticationToken.class))).thenThrow(new BadCredentialsException(&quot;Bad credentials&quot;));</span>

<span class="pc" id="L171">        assertThatThrownBy(() -&gt; authenticationService.loginUser(username, password))</span>
<span class="fc" id="L172">                .isInstanceOf(BadCredentialsException.class);</span>
<span class="fc" id="L173">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>