<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReplyServiceTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in middleware Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.vision.testing.service</a> &gt; <span class="el_source">ReplyServiceTest.java</span></div><h1>ReplyServiceTest.java</h1><pre class="source lang-java linenums">package com.vision.testing.service;

import com.vision.middleware.domain.ApplicationUser;
import com.vision.middleware.domain.Post;
import com.vision.middleware.domain.Reply;
import com.vision.middleware.domain.relations.UserVote;
import com.vision.middleware.dto.ReplyDTO;
import com.vision.middleware.exceptions.IdNotFoundException;
import com.vision.middleware.repo.ReplyRepository;
import com.vision.middleware.service.PostService;
import com.vision.middleware.service.ReplyService;
import com.vision.middleware.service.UserService;
import com.vision.middleware.service.VotingService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.*;

import static org.assertj.core.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
<span class="fc" id="L28">public class ReplyServiceTest {</span>

    @Mock
    private ReplyRepository replyRepository;

    @Mock
    private UserService userService;

    @Mock
    private PostService postService;

    @Mock
    private VotingService votingService;

    @InjectMocks
    private ReplyService replyService;

    private ApplicationUser testUser;
    private Post testPost;
    private Reply testReply;
    private Reply testChildReply;

    @BeforeEach
    void setUp() {
<span class="fc" id="L52">        testUser = ApplicationUser.builder()</span>
<span class="fc" id="L53">                .id(1L)</span>
<span class="fc" id="L54">                .username(&quot;testuser&quot;)</span>
<span class="fc" id="L55">                .password(&quot;testpassword&quot;)</span>
<span class="fc" id="L56">                .fullName(&quot;testname&quot;)</span>
<span class="fc" id="L57">                .email(&quot;test@email.com&quot;)</span>
<span class="fc" id="L58">                .phoneNumber(&quot;1234567890&quot;)</span>
<span class="fc" id="L59">                .build();</span>

<span class="fc" id="L61">        testPost = Post.builder()</span>
<span class="fc" id="L62">                .id(1L)</span>
<span class="fc" id="L63">                .build();</span>

<span class="fc" id="L65">        testChildReply = Reply.builder()</span>
<span class="fc" id="L66">                        .id(2L)</span>
<span class="fc" id="L67">                        .post(testPost)</span>
<span class="fc" id="L68">                        .author(testUser)</span>
<span class="fc" id="L69">                        .text(&quot;Child test reply content&quot;)</span>
<span class="fc" id="L70">                        .datePosted(new Date())</span>
<span class="fc" id="L71">                        .childReplies(new HashSet&lt;&gt;())</span>
<span class="fc" id="L72">                        .build();</span>

<span class="fc" id="L74">        testReply = Reply.builder()</span>
<span class="fc" id="L75">                .id(1L)</span>
<span class="fc" id="L76">                .post(testPost)</span>
<span class="fc" id="L77">                .author(testUser)</span>
<span class="fc" id="L78">                .text(&quot;Test reply content&quot;)</span>
<span class="fc" id="L79">                .datePosted(new Date())</span>
<span class="fc" id="L80">                .childReplies(new HashSet&lt;&gt;(Collections.singletonList(testChildReply)))</span>
<span class="fc" id="L81">                .build();</span>
<span class="fc" id="L82">    }</span>

    @Test
    void createReply_ValidInput_ReplyCreatedSuccessfully() {
<span class="fc" id="L86">        when(replyRepository.save(any(Reply.class))).thenReturn(testReply);</span>

<span class="fc" id="L88">        Reply createdReply = replyService.createReply(testPost, testUser, &quot;Test reply content&quot;, null);</span>

<span class="fc" id="L90">        assertThat(createdReply).isNotNull();</span>
<span class="fc" id="L91">        assertThat(createdReply.getPost()).isEqualTo(testPost);</span>
<span class="fc" id="L92">        assertThat(createdReply.getAuthor()).isEqualTo(testUser);</span>
<span class="fc" id="L93">        assertThat(createdReply.getText()).isEqualTo(&quot;Test reply content&quot;);</span>

<span class="fc" id="L95">        verify(replyRepository).save(any(Reply.class));</span>
<span class="fc" id="L96">    }</span>

    @Test
    void createReply_EmptyText_ThrowsIllegalArgumentException() {
<span class="fc" id="L100">        assertThatThrownBy(() -&gt;</span>
<span class="nc" id="L101">                replyService.createReply(testPost, testUser, &quot;&quot;, null)</span>
<span class="fc" id="L102">        ).isInstanceOf(IllegalArgumentException.class)</span>
<span class="fc" id="L103">                .hasMessageContaining(&quot;Reply text cannot be empty&quot;);</span>
<span class="fc" id="L104">    }</span>

    @Test
    void createReply_TextTooLong_ThrowsIllegalArgumentException() {
<span class="fc" id="L108">        String longText = &quot;x&quot;.repeat(5001);</span>

<span class="fc" id="L110">        assertThatThrownBy(() -&gt;</span>
<span class="nc" id="L111">                replyService.createReply(testPost, testUser, longText, null)</span>
<span class="fc" id="L112">        ).isInstanceOf(IllegalArgumentException.class)</span>
<span class="fc" id="L113">                .hasMessageContaining(&quot;exceeds maximum length&quot;);</span>
<span class="fc" id="L114">    }</span>

    @Test
    void createReply_NestedReplyExceedingMaxDepth_ThrowsIllegalArgumentException() {
        // Create a deeply nested reply chain
<span class="fc" id="L119">        Reply deepestParent = testReply;</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">        for (int i = 0; i &lt; 100; i++) {</span>
<span class="fc" id="L121">            deepestParent = Reply.builder()</span>
<span class="fc" id="L122">                    .parentReply(deepestParent)</span>
<span class="fc" id="L123">                    .build();</span>
        }

<span class="fc" id="L126">        Reply finalDeepestParent = deepestParent;</span>
<span class="fc" id="L127">        assertThatThrownBy(() -&gt;</span>
<span class="nc" id="L128">                replyService.createReply(testPost, testUser, &quot;Nested reply&quot;, finalDeepestParent)</span>
<span class="fc" id="L129">        ).isInstanceOf(IllegalArgumentException.class)</span>
<span class="fc" id="L130">                .hasMessageContaining(&quot;Maximum nesting depth&quot;);</span>
<span class="fc" id="L131">    }</span>

    @Test
    void createChildReply_ValidInput_ReplyCreatedSuccessfully() {
        // given that parent reply has no replies:
<span class="fc" id="L136">        testReply.setChildReplies(new HashSet&lt;&gt;());</span>

<span class="fc" id="L138">        testChildReply.setParentReply(testReply);</span>
<span class="fc" id="L139">        when(replyRepository.save(any(Reply.class))).thenReturn(testChildReply);</span>

<span class="fc" id="L141">        Reply createdReply = replyService.createReply(testPost, testUser, &quot;Child test reply content&quot;, testReply);</span>

<span class="fc" id="L143">        assertThat(createdReply).isNotNull();</span>
<span class="fc" id="L144">        assertThat(createdReply.getPost()).isEqualTo(testPost);</span>
<span class="fc" id="L145">        assertThat(createdReply.getAuthor()).isEqualTo(testUser);</span>
<span class="fc" id="L146">        assertThat(createdReply.getText()).isEqualTo(&quot;Child test reply content&quot;);</span>

<span class="fc" id="L148">        assertThat(createdReply.getParentReply().getId()).isEqualTo(testReply.getId());</span>

<span class="fc" id="L150">        verify(replyRepository).save(any(Reply.class));</span>
<span class="fc" id="L151">    }</span>

    @Test
    void findReplyById_ExistingReply_ReturnsReply() {
<span class="fc" id="L155">        when(replyRepository.findById(1L)).thenReturn(Optional.of(testReply));</span>

<span class="fc" id="L157">        Reply foundReply = replyService.findReplyById(1L);</span>

<span class="fc" id="L159">        assertThat(foundReply).isEqualTo(testReply);</span>
<span class="fc" id="L160">    }</span>

    @Test
    void findReplyById_NonExistingReply_ThrowsIdNotFoundException() {
<span class="fc" id="L164">        when(replyRepository.findById(anyLong())).thenReturn(Optional.empty());</span>

<span class="fc" id="L166">        assertThatThrownBy(() -&gt;</span>
<span class="nc" id="L167">                replyService.findReplyById(999L)</span>
<span class="fc" id="L168">        ).isInstanceOf(IdNotFoundException.class)</span>
<span class="fc" id="L169">                .hasMessageContaining(&quot;Reply with id 999 not found&quot;);</span>
<span class="fc" id="L170">    }</span>

    @Test
    void voteOnReply_ValidInput_VotingServiceCalled() {
<span class="fc" id="L174">        doNothing().when(votingService).voteOnVotable(testUser, testReply, UserVote.VoteType.LIKE);</span>

<span class="fc" id="L176">        replyService.voteOnReply(testUser, testReply, UserVote.VoteType.LIKE);</span>

<span class="fc" id="L178">        verify(votingService).voteOnVotable(testUser, testReply, UserVote.VoteType.LIKE);</span>
<span class="fc" id="L179">    }</span>

    @Test
    void deleteReply_WithoutChildren_DeletedCompletely() {
<span class="fc" id="L183">        testReply.setChildReplies(new HashSet&lt;&gt;());</span>
<span class="fc" id="L184">        Reply parentReply = Reply.builder()</span>
<span class="fc" id="L185">                .id(2L)</span>
<span class="fc" id="L186">                .build();</span>
<span class="fc" id="L187">        testReply.setParentReply(parentReply);</span>

<span class="fc" id="L189">        replyService.deleteReply(testReply);</span>

<span class="fc" id="L191">        verify(replyRepository).delete(testReply);</span>
<span class="fc" id="L192">        verify(replyRepository).save(parentReply);</span>
<span class="fc" id="L193">    }</span>

    @Test
    void deleteReply_WithChildren_SoftDeleted() {
<span class="fc" id="L197">        Reply childReply = Reply.builder()</span>
<span class="fc" id="L198">                .id(3L)</span>
<span class="fc" id="L199">                .build();</span>
<span class="fc" id="L200">        testReply.addChildReply(childReply);</span>

<span class="fc" id="L202">        when(replyRepository.save(testReply)).thenReturn(testReply);</span>

<span class="fc" id="L204">        replyService.deleteReply(testReply);</span>

<span class="fc" id="L206">        assertThat(testReply.isDeleted()).isTrue();</span>
<span class="fc" id="L207">        assertThat(testReply.getText()).isEqualTo(&quot;[deleted]&quot;);</span>
<span class="fc" id="L208">        verify(replyRepository).save(testReply);</span>
<span class="fc" id="L209">    }</span>

    @Test
    void getCommentTreeForPost_ReturnsCorrectStructure() {
<span class="fc" id="L213">        List&lt;Reply&gt; topLevelReplies = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L214">        topLevelReplies.add(testReply);</span>

<span class="fc" id="L216">        when(replyRepository.findTopLevelRepliesByPostId(1L)).thenReturn(topLevelReplies);</span>
<span class="fc" id="L217">        when(votingService.getUserVoteOnVotable(testUser, testReply)).thenReturn(Optional.empty());</span>

<span class="fc" id="L219">        List&lt;ReplyDTO&gt; commentTree = replyService.getCommentTreeForPost(1L, testUser);</span>

<span class="fc" id="L221">        assertThat(commentTree).hasSize(1);</span>
<span class="fc" id="L222">        ReplyDTO firstReply = commentTree.get(0);</span>
<span class="fc" id="L223">        assertThat(firstReply.getId()).isEqualTo(testReply.getId());</span>
<span class="fc" id="L224">        assertThat(firstReply.getText()).isEqualTo(testReply.getText());</span>

<span class="fc" id="L226">        ReplyDTO childReply = commentTree.get(0).getReplies().get(0);</span>
<span class="fc" id="L227">        assertThat(childReply.getId()).isEqualTo(testChildReply.getId());</span>
<span class="fc" id="L228">        assertThat(childReply.getText()).isEqualTo(testChildReply.getText());</span>
<span class="fc" id="L229">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>