<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MediaControllerTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in middleware Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.vision.testing.controller</a> &gt; <span class="el_source">MediaControllerTest.java</span></div><h1>MediaControllerTest.java</h1><pre class="source lang-java linenums">package com.vision.testing.controller;

import com.amazonaws.services.s3.model.ObjectMetadata;
import com.amazonaws.services.s3.model.S3Object;
import com.amazonaws.services.s3.model.S3ObjectInputStream;
import com.vision.middleware.controller.MediaController;
import com.vision.middleware.exceptions.InvalidFileException;
import com.vision.middleware.exceptions.MediaNotFoundException;
import com.vision.middleware.exceptions.MediaUploadException;
import com.vision.middleware.service.MediaService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.core.io.InputStreamResource;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.mock.web.MockMultipartFile;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;

import java.io.ByteArrayInputStream;
import java.io.IOException;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.multipart;
import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

@ExtendWith(MockitoExtension.class)
<span class="fc" id="L38">class MediaControllerTest {</span>

    private MockMvc mockMvc;

    @Mock
    private MediaService mediaService;

    @InjectMocks
    private MediaController mediaController;

    @BeforeEach
    void setUp() {
<span class="fc" id="L50">        mockMvc = MockMvcBuilders.standaloneSetup(mediaController).build();</span>
<span class="fc" id="L51">    }</span>

    @Test
    void uploadMedia_ValidFile_ReturnsFileName() {
        // Arrange
<span class="fc" id="L56">        String expectedFileName = &quot;sample-image.png&quot;;</span>
<span class="fc" id="L57">        MockMultipartFile mockFile = new MockMultipartFile(</span>
                &quot;file&quot;,
                &quot;sample-image.png&quot;,
                &quot;image/png&quot;,
                new byte[]{1, 2, 3, 4, 5} // Minimal PNG byte content
        );

<span class="fc" id="L64">        when(mediaService.uploadMedia(any())).thenReturn(expectedFileName);</span>

        // Act &amp; Assert
<span class="fc" id="L67">        ResponseEntity&lt;String&gt; response = mediaController.uploadMedia(mockFile);</span>

<span class="fc" id="L69">        assertThat(response.getStatusCode().value()).isEqualTo(200);</span>
<span class="fc" id="L70">        assertThat(response.getBody()).isEqualTo(expectedFileName);</span>
<span class="fc" id="L71">        verify(mediaService).uploadMedia(mockFile);</span>
<span class="fc" id="L72">    }</span>

    @Test
    void getMedia_ExistingFile_ReturnsCorrectResponse() throws IOException {
        // Arrange
<span class="fc" id="L77">        String fileName = &quot;sample-image.png&quot;;</span>
<span class="fc" id="L78">        S3Object mockS3Object = mock(S3Object.class);</span>
<span class="fc" id="L79">        ObjectMetadata mockMetadata = new ObjectMetadata();</span>
<span class="fc" id="L80">        mockMetadata.setContentType(&quot;image/png&quot;);</span>
<span class="fc" id="L81">        mockMetadata.setContentLength(100L);</span>

<span class="fc" id="L83">        byte[] fileContent = new byte[]{1, 2, 3, 4, 5}; // Minimal PNG byte content</span>
<span class="fc" id="L84">        S3ObjectInputStream mockInputStream = new S3ObjectInputStream(</span>
                new ByteArrayInputStream(fileContent),
                null
        );

<span class="fc" id="L89">        when(mockS3Object.getObjectMetadata()).thenReturn(mockMetadata);</span>
<span class="fc" id="L90">        when(mockS3Object.getObjectContent()).thenReturn(mockInputStream);</span>

<span class="fc" id="L92">        when(mediaService.getMedia(fileName)).thenReturn(mockS3Object);</span>

        // Act
<span class="fc" id="L95">        ResponseEntity&lt;InputStreamResource&gt; response = mediaController.getMedia(fileName);</span>

        // Assert
<span class="fc" id="L98">        assertThat(response.getStatusCode().value()).isEqualTo(200);</span>

<span class="fc" id="L100">        HttpHeaders headers = response.getHeaders();</span>
<span class="fc" id="L101">        assertThat(headers.getContentType()).isEqualTo(MediaType.parseMediaType(&quot;image/png&quot;));</span>
<span class="fc" id="L102">        assertThat(headers.getContentLength()).isEqualTo(100L);</span>

<span class="fc" id="L104">        verify(mediaService).getMedia(fileName);</span>
<span class="fc" id="L105">    }</span>

    @Test
    void uploadMedia_EndpointValidation_Success() throws Exception {
        // Arrange
<span class="fc" id="L110">        MockMultipartFile mockFile = new MockMultipartFile(</span>
                &quot;file&quot;,
                &quot;sample-image.png&quot;,
                &quot;image/png&quot;,
                new byte[]{1, 2, 3, 4, 5} // Minimal PNG byte content
        );

<span class="fc" id="L117">        when(mediaService.uploadMedia(any())).thenReturn(&quot;sample-image.png&quot;);</span>

        // Act &amp; Assert
<span class="fc" id="L120">        mockMvc.perform(multipart(&quot;/media/upload&quot;)</span>
<span class="fc" id="L121">                        .file(mockFile))</span>
<span class="fc" id="L122">                .andExpect(status().isOk())</span>
<span class="fc" id="L123">                .andExpect(content().string(&quot;sample-image.png&quot;));</span>
<span class="fc" id="L124">    }</span>

    @Test
    void getMedia_EndpointValidation_Success() throws Exception {
        // Arrange
<span class="fc" id="L129">        String fileName = &quot;sample-image.png&quot;;</span>
<span class="fc" id="L130">        S3Object mockS3Object = mock(S3Object.class);</span>
<span class="fc" id="L131">        ObjectMetadata mockMetadata = new ObjectMetadata();</span>
<span class="fc" id="L132">        mockMetadata.setContentType(&quot;image/png&quot;);</span>
<span class="fc" id="L133">        mockMetadata.setContentLength(100L);</span>

<span class="fc" id="L135">        byte[] fileContent = new byte[]{1, 2, 3, 4, 5}; // Minimal PNG byte content</span>
<span class="fc" id="L136">        S3ObjectInputStream mockInputStream = new S3ObjectInputStream(</span>
                new ByteArrayInputStream(fileContent),
                null
        );

<span class="fc" id="L141">        when(mockS3Object.getObjectMetadata()).thenReturn(mockMetadata);</span>
<span class="fc" id="L142">        when(mockS3Object.getObjectContent()).thenReturn(mockInputStream);</span>

<span class="fc" id="L144">        when(mediaService.getMedia(fileName)).thenReturn(mockS3Object);</span>

        // Act &amp; Assert
<span class="fc" id="L147">        mockMvc.perform(get(&quot;/media/{fileName}&quot;, fileName))</span>
<span class="fc" id="L148">                .andExpect(status().isOk())</span>
<span class="fc" id="L149">                .andExpect(content().contentType(&quot;image/png&quot;))</span>
<span class="fc" id="L150">                .andExpect(header().longValue(&quot;Content-Length&quot;, 100L));</span>
<span class="fc" id="L151">    }</span>

    @Test
    void uploadMedia_EmptyFile_ShouldHandleGracefully() {
        // Arrange
<span class="fc" id="L156">        MockMultipartFile emptyFile = new MockMultipartFile(</span>
                &quot;file&quot;,
                &quot;empty-image.png&quot;,
                &quot;image/png&quot;,
                new byte[0]
        );

<span class="fc" id="L163">        when(mediaService.uploadMedia(any())).thenThrow(new InvalidFileException(&quot;empty file&quot;));</span>

        // Act and assert
<span class="fc" id="L166">        assertThat(mediaController.uploadMedia(emptyFile).getStatusCode()).isEqualTo(HttpStatus.BAD_REQUEST);</span>
<span class="fc" id="L167">    }</span>

    @Test
    void getMedia_NonExistentFile_ShouldHandleGracefully() throws Exception {
        // Arrange
<span class="fc" id="L172">        String nonExistentFileName = &quot;non-existent-image.png&quot;;</span>
<span class="fc" id="L173">        when(mediaService.getMedia(nonExistentFileName)).thenThrow(new MediaNotFoundException(&quot;media not found&quot;));</span>

        // Act &amp; Assert
<span class="fc" id="L176">        mockMvc.perform(get(&quot;/media/{fileName}&quot;, nonExistentFileName))</span>
<span class="fc" id="L177">                .andDo(print())</span>
<span class="fc" id="L178">                .andExpect(status().isNotFound());</span>
<span class="fc" id="L179">    }</span>

    @Test
    void uploadMedia_UnsupportedFileType_BadRequest() {
        // Arrange
<span class="fc" id="L184">        MockMultipartFile unsupportedFile = new MockMultipartFile(</span>
                &quot;file&quot;,
                &quot;document.txt&quot;,
                &quot;text/plain&quot;,
                new byte[]{1, 2, 3, 4, 5} // Some file content
        );

<span class="fc" id="L191">        when(mediaService.uploadMedia(any())).thenThrow(new InvalidFileException(&quot;Unsupported file type&quot;));</span>

        // Act &amp; Assert
<span class="fc" id="L194">        ResponseEntity&lt;String&gt; response = mediaController.uploadMedia(unsupportedFile);</span>
<span class="fc" id="L195">        assertThat(response.getStatusCode()).isEqualTo(HttpStatus.BAD_REQUEST);</span>
<span class="fc" id="L196">        assertThat(response.getBody()).isEqualTo(&quot;Unsupported file type&quot;);</span>
<span class="fc" id="L197">    }</span>

    @Test
    void uploadMedia_UnsupportedFileType_EndpointValidation() throws Exception {
        // Arrange
<span class="fc" id="L202">        MockMultipartFile unsupportedFile = new MockMultipartFile(</span>
                &quot;file&quot;,
                &quot;document.txt&quot;,
                &quot;text/plain&quot;,
                new byte[]{1, 2, 3, 4, 5} // Some file content
        );

<span class="fc" id="L209">        when(mediaService.uploadMedia(any())).thenThrow(new InvalidFileException(&quot;Unsupported file type&quot;));</span>

        // Act &amp; Assert
<span class="fc" id="L212">        mockMvc.perform(multipart(&quot;/media/upload&quot;).file(unsupportedFile))</span>
<span class="fc" id="L213">                .andExpect(status().isBadRequest())</span>
<span class="fc" id="L214">                .andExpect(content().string(&quot;Unsupported file type&quot;));</span>
<span class="fc" id="L215">    }</span>

    @Test
    void uploadMedia_S3UploadError() {
        // Arrange
<span class="fc" id="L220">        MockMultipartFile mockFile = new MockMultipartFile(</span>
                &quot;file&quot;,
                &quot;sample-image.png&quot;,
                &quot;image/png&quot;,
                new byte[]{1, 2, 3, 4, 5} // Minimal PNG byte content
        );

<span class="fc" id="L227">        when(mediaService.uploadMedia(any())).thenThrow(new MediaUploadException(&quot;upload failed&quot;, new IOException()));</span>

        // Act and assert
<span class="fc" id="L230">        assertThat(mediaController.uploadMedia(mockFile).getStatusCode()).isEqualTo(HttpStatus.INTERNAL_SERVER_ERROR);</span>
<span class="fc" id="L231">    }</span>

    @Test
    void uploadMedia_S3UploadError_EndpointValidation() throws Exception {
        // Arrange
<span class="fc" id="L236">        MockMultipartFile mockFile = new MockMultipartFile(</span>
                &quot;file&quot;,
                &quot;sample-image.png&quot;,
                &quot;image/png&quot;,
                new byte[]{1, 2, 3, 4, 5} // Minimal PNG byte content
        );

<span class="fc" id="L243">        when(mediaService.uploadMedia(any())).thenThrow(new MediaUploadException(&quot;upload failed&quot;, new IOException()));</span>

        // Act and assert
<span class="fc" id="L246">        mockMvc.perform(multipart(&quot;/media/upload&quot;).file(mockFile))</span>
<span class="fc" id="L247">                .andExpect(status().isInternalServerError())</span>
<span class="fc" id="L248">                .andExpect(content().string(&quot;upload failed&quot;));</span>
<span class="fc" id="L249">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>