<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthenticationControllerTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">java in middleware Coverage Results</a> &gt; <a href="index.source.html" class="el_package">com.vision.testing.controller</a> &gt; <span class="el_source">AuthenticationControllerTest.java</span></div><h1>AuthenticationControllerTest.java</h1><pre class="source lang-java linenums">package com.vision.testing.controller;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.vision.middleware.Application;
import com.vision.middleware.config.SecurityConfig;
import com.vision.middleware.controller.AuthenticationController;
import com.vision.middleware.domain.ApplicationUser;
import com.vision.middleware.dto.LoginDTO;
import com.vision.middleware.dto.LoginResponseDTO;
import com.vision.middleware.dto.RegistrationDTO;
import com.vision.middleware.service.AuthenticationService;
import com.vision.middleware.utils.JwtUtil;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.context.annotation.Import;
import org.springframework.http.MediaType;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;
import org.springframework.test.web.servlet.result.MockMvcResultMatchers;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;

import java.util.Collection;
import java.util.Collections;
import java.util.List;

import static org.hamcrest.Matchers.emptyOrNullString;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.when;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

<span class="fc" id="L47">@ExtendWith(MockitoExtension.class)</span>
@ContextConfiguration
<span class="fc" id="L49">public class AuthenticationControllerTest {</span>

    private MockMvc mockMvc;
    private ObjectMapper objectMapper;

    @Mock
    private AuthenticationService authenticationService;

    @InjectMocks
    private AuthenticationController authenticationController;
    
    @Autowired
    private JwtUtil jwtUtil;

    private static RegistrationDTO validUserDTO;

    @BeforeEach
    public void setUp() {
<span class="fc" id="L67">        mockMvc = MockMvcBuilders.standaloneSetup(authenticationController).build();</span>
<span class="fc" id="L68">        objectMapper = new ObjectMapper();</span>

<span class="fc" id="L70">        validUserDTO = RegistrationDTO.builder()</span>
<span class="fc" id="L71">                .username(&quot;testUser&quot;)</span>
<span class="fc" id="L72">                .password(&quot;testPassword&quot;)</span>
<span class="fc" id="L73">                .email(&quot;test@example.com&quot;)</span>
<span class="fc" id="L74">                .city(&quot;somewhere&quot;)</span>
<span class="fc" id="L75">                .state(&quot;ca&quot;)</span>
<span class="fc" id="L76">                .country(&quot;nowhere&quot;)</span>
<span class="fc" id="L77">                .zipCode(&quot;11111&quot;)</span>
<span class="fc" id="L78">                .phoneNumber(&quot;1234567890&quot;)</span>
<span class="fc" id="L79">                .fullName(&quot;test User&quot;)</span>
<span class="fc" id="L80">                .address(&quot;place at place 111&quot;)</span>
<span class="fc" id="L81">                .build();</span>
<span class="fc" id="L82">    }</span>

    @Test
    public void testRegisterUser_Success() throws Exception {
        // Arrange
<span class="fc" id="L87">        RegistrationDTO registrationDTO = validUserDTO;</span>

<span class="fc" id="L89">        ApplicationUser user = new ApplicationUser();</span>
<span class="fc" id="L90">        user.setId(1L);</span>
<span class="fc" id="L91">        user.setUsername(&quot;testUser&quot;);</span>
<span class="fc" id="L92">        user.setEmail(&quot;test@example.com&quot;);</span>

<span class="fc" id="L94">        when(authenticationService.registerUser(any(RegistrationDTO.class))).thenReturn(user);</span>

        // Act &amp; Assert
<span class="fc" id="L97">        mockMvc.perform(post(&quot;/auth/register&quot;)</span>
<span class="fc" id="L98">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L99">                        .content(objectMapper.writeValueAsString(registrationDTO)))</span>
<span class="fc" id="L100">                .andDo(print())</span>
<span class="fc" id="L101">                .andExpect(status().isOk())</span>
<span class="fc" id="L102">                .andExpect(MockMvcResultMatchers.jsonPath(&quot;$.userId&quot;).value(1L))</span>
<span class="fc" id="L103">                .andExpect(MockMvcResultMatchers.jsonPath(&quot;$.username&quot;).value(&quot;testUser&quot;))</span>
<span class="fc" id="L104">                .andExpect(MockMvcResultMatchers.jsonPath(&quot;$.email&quot;).value(&quot;test@example.com&quot;));</span>
<span class="fc" id="L105">    }</span>

    @Test
    public void testRegisterUser_Failure() throws Exception {
        // Arrange
<span class="fc" id="L110">        RegistrationDTO registrationDTO = validUserDTO;</span>

<span class="fc" id="L112">        when(authenticationService.registerUser(any(RegistrationDTO.class))).thenThrow(new RuntimeException(&quot;Account creation failed.&quot;));</span>

        // Act &amp; Assert
<span class="fc" id="L115">        mockMvc.perform(post(&quot;/auth/register&quot;)</span>
<span class="fc" id="L116">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L117">                        .content(objectMapper.writeValueAsString(registrationDTO)))</span>
<span class="fc" id="L118">                .andDo(print())</span>
<span class="fc" id="L119">                .andExpect(status().isBadRequest())</span>
<span class="fc" id="L120">                .andExpect(MockMvcResultMatchers.content().string(&quot;Account creation failed.&quot;));</span>
<span class="fc" id="L121">    }</span>

    @Test
    public void testRegisterUser_Failure_DuplicateUsername() throws Exception {
        // Arrange
<span class="fc" id="L126">        RegistrationDTO registrationDTO = validUserDTO;</span>

<span class="fc" id="L128">        when(authenticationService.registerUser(any(RegistrationDTO.class))).thenThrow(new RuntimeException(&quot;Duplicate Key (username).&quot;));</span>

        // Act &amp; Assert
<span class="fc" id="L131">        mockMvc.perform(post(&quot;/auth/register&quot;)</span>
<span class="fc" id="L132">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L133">                        .content(objectMapper.writeValueAsString(registrationDTO)))</span>
<span class="fc" id="L134">                .andDo(print())</span>
<span class="fc" id="L135">                .andExpect(status().isBadRequest())</span>
<span class="fc" id="L136">                .andExpect(MockMvcResultMatchers.content().string(&quot;Username already exists\n&quot;));</span>
<span class="fc" id="L137">    }</span>

    @Test
    public void testRegisterUser_Failure_DuplicateEmail() throws Exception {
        // Arrange
<span class="fc" id="L142">        RegistrationDTO registrationDTO = validUserDTO;</span>

<span class="fc" id="L144">        when(authenticationService.registerUser(any(RegistrationDTO.class))).thenThrow(new RuntimeException(&quot;Duplicate Key (email).&quot;));</span>

        // Act &amp; Assert
<span class="fc" id="L147">        mockMvc.perform(post(&quot;/auth/register&quot;)</span>
<span class="fc" id="L148">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L149">                        .content(objectMapper.writeValueAsString(registrationDTO)))</span>
<span class="fc" id="L150">                .andDo(print())</span>
<span class="fc" id="L151">                .andExpect(status().isBadRequest())</span>
<span class="fc" id="L152">                .andExpect(MockMvcResultMatchers.content().string(&quot;Email already registered\n&quot;));</span>
<span class="fc" id="L153">    }</span>

    @Test
    public void testRegisterUser_Failure_DuplicatePhoneNumber() throws Exception {
        // Arrange
<span class="fc" id="L158">        RegistrationDTO registrationDTO = validUserDTO;</span>

<span class="fc" id="L160">        when(authenticationService.registerUser(any(RegistrationDTO.class))).thenThrow(new RuntimeException(&quot;Duplicate Key (phone_number).&quot;));</span>

        // Act &amp; Assert
<span class="fc" id="L163">        mockMvc.perform(post(&quot;/auth/register&quot;)</span>
<span class="fc" id="L164">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L165">                        .content(objectMapper.writeValueAsString(registrationDTO)))</span>
<span class="fc" id="L166">                .andDo(print())</span>
<span class="fc" id="L167">                .andExpect(status().isBadRequest())</span>
<span class="fc" id="L168">                .andExpect(MockMvcResultMatchers.content().string(&quot;Phone number already in use\n&quot;));</span>
<span class="fc" id="L169">    }</span>

    @Test
    public void testRegisterUser_DTOBindFailure() throws Exception {
        // Create an invalid DTO with missing/invalid fields
<span class="fc" id="L174">        String invalidRegistrationJson = &quot;{&quot; +</span>
                &quot;\&quot;username\&quot;: \&quot;\&quot;,&quot; +
                &quot;\&quot;password\&quot;: \&quot;short\&quot;,&quot; +
                &quot;\&quot;email\&quot;: \&quot;invalid-email\&quot;,&quot; +
                &quot;\&quot;phoneNumber\&quot;: \&quot;123\&quot;&quot; +
                &quot;}&quot;;

<span class="fc" id="L181">        mockMvc.perform(post(&quot;/auth/register&quot;)</span>
<span class="fc" id="L182">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L183">                        .content(invalidRegistrationJson))</span>
<span class="fc" id="L184">                .andDo(print())</span>
<span class="fc" id="L185">                .andExpect(status().isBadRequest())</span>
<span class="fc" id="L186">                .andExpect(result -&gt; {</span>
<span class="fc" id="L187">                    String responseBody = result.getResponse().getContentAsString();</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">                    assert responseBody.contains(&quot;Username is required&quot;);</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">                    assert responseBody.contains(&quot;Password must be at least 8 characters&quot;);</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">                    assert responseBody.contains(&quot;Invalid email format&quot;);</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">                    assert responseBody.contains(&quot;Invalid phone number&quot;);</span>
<span class="fc" id="L192">                });</span>
<span class="fc" id="L193">    }</span>

    @Test
    public void testLoginUser_Success() throws Exception {
        // Arrange
<span class="fc" id="L198">        LoginDTO loginDTO = new LoginDTO(&quot;testUser&quot;, &quot;testPassword&quot;);</span>

<span class="fc" id="L200">        LoginResponseDTO loginResponseDTO = new LoginResponseDTO();</span>
<span class="fc" id="L201">        loginResponseDTO.setUsername(&quot;dummyResult&quot;);</span>

<span class="fc" id="L203">        when(authenticationService.loginUser(&quot;testUser&quot;, &quot;testPassword&quot;)).thenReturn(loginResponseDTO);</span>

        // Act &amp; Assert
<span class="fc" id="L206">        mockMvc.perform(post(&quot;/auth/login&quot;)</span>
<span class="fc" id="L207">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L208">                        .content(objectMapper.writeValueAsString(loginDTO)))</span>
<span class="fc" id="L209">                .andDo(print())</span>
<span class="fc" id="L210">                .andExpect(status().isOk());</span>
<span class="fc" id="L211">    }</span>

    @Test
    public void testLoginUser_Failure() throws Exception {
        // Arrange
<span class="fc" id="L216">        LoginDTO loginDTO = new LoginDTO(&quot;testUser&quot;, &quot;testPassword&quot;);</span>

<span class="fc" id="L218">        when(authenticationService.loginUser(&quot;testUser&quot;, &quot;testPassword&quot;)).thenThrow(new AuthenticationException(&quot;Login failed.&quot;) {});</span>

        // Act &amp; Assert
<span class="fc" id="L221">        mockMvc.perform(post(&quot;/auth/login&quot;)</span>
<span class="fc" id="L222">                        .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L223">                        .content(objectMapper.writeValueAsString(loginDTO)))</span>
<span class="fc" id="L224">                .andDo(print())</span>
<span class="fc" id="L225">                .andExpect(status().isUnauthorized())</span>
<span class="fc" id="L226">                .andExpect(MockMvcResultMatchers.content().string(emptyOrNullString()));</span>
<span class="fc" id="L227">    }</span>

    @Test
    public void testValidTokenWithUserRole() throws Exception {
        // Setup authentication with USER role
<span class="fc" id="L232">        setupAuthentication(&quot;USER&quot;);</span>

<span class="fc" id="L234">        mockMvc.perform(MockMvcRequestBuilders.get(&quot;/auth/validate&quot;)</span>
<span class="fc" id="L235">                        .header(&quot;Authorization&quot;, &quot;valid-token&quot;))</span>
<span class="fc" id="L236">                .andExpect(status().isOk())</span>
<span class="fc" id="L237">                .andExpect(MockMvcResultMatchers.content().string(&quot;Token is valid&quot;));</span>
<span class="fc" id="L238">    }</span>

    // Utility method to set up authentication with a specific role
    private void setupAuthentication(String role) {
<span class="fc" id="L242">        List&lt;SimpleGrantedAuthority&gt; authorities =</span>
<span class="fc" id="L243">                Collections.singletonList(new SimpleGrantedAuthority(&quot;ROLE_&quot; + role));</span>

<span class="fc" id="L245">        Authentication authentication = new UsernamePasswordAuthenticationToken(</span>
                &quot;testuser&quot;, &quot;password&quot;, authorities);

<span class="fc" id="L248">        SecurityContext securityContext = SecurityContextHolder.getContext();</span>
<span class="fc" id="L249">        securityContext.setAuthentication(authentication);</span>
<span class="fc" id="L250">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>